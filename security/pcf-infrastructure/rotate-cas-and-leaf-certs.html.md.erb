---
title: Rotating CAs and leaf certificates using the Tanzu Operations Manager API
owner: Ops Manager
---

This topic describes how you can rotate certificate authorities (CAs) and leaf certificates using the <%= vars.ops_manager_first %> API. To rotate only leaf certificates, see one of the leaf certificate rotation topics listed in [Certificate Rotation Procedures](api-cert-rotation.html#procedures) in _Overview of Certificate Rotation_.

This procedure uses the <%= vars.ops_manager %> API to rotate all CA and leaf certificates generated by <%= vars.ops_manager %> and CredHub.

This procedure includes three redeployments. The first deployment adds the new CA certificates to <%= vars.ops_manager %> components. The second deploy replaces the old leaf certificates with the new leaf certificates. The third deploy removes the old CA certificates, leaving only the new CA certificates.

## <a id='rotated-certificates'></a> Certificates rotated by the procedure

This procedure rotates all certificates listed on the Certificates page within <%= vars.ops_manager %>, except those with specialized rotation procedures.

Certificates that match the following characteristics will be rotated:

* All non-configurable certificates
* All configurable Ops Manager certificates

<!-- * Type is either `CA` or `Leaf`
* Location is either `credhub` or `ops_manager`
* Configurable is `No`. -->

Some certificates require a different procedure to rotate. For more information, see [Certificates with specialized procedures](#specialized-procedures).

<!-- TODO: Create a section for excluded certs -->
The <%= vars.ops_manager %> API also excludes from rotation the CAs for certain versions of the VMware Tanzu SQL [MySQL for VMs], Redis for VMware Tanzu, VMware Tanzu RabbitMQ, and VMware Tanzu GemFire tiles and IPsec for VMware Tanzu. For information about rotating these CAs, see the documentation for those products.

## <a id='prerequisites'></a> Prerequisites

<%= partial "rotate-cas-certs-prereqs" %>

## <a id='procedure'></a> Procedure

<%= partial 'minimum-duration' %>

To rotate CAs, configurable leaf certificates, and non-configurable leaf certificates:

<p> You must complete these steps in the exact order specified. Otherwise, you can damage your deployment.</p>

1. Regenerate CAs. This step also automatically adds new CAs for all CAs visible to the <%= vars.ops_manager %> API. For more information, see [Regenerate CAs](#add-new-ca) below.

1. Activate the new CAs. This step also automatically activates any other new CAs added in the previous step. For more information, see [Activate the CAs](#activate-new-ca) below.

1. Rotate configurable leaf certificates. For more information, see [Rotate configurable Leaf Certificates](#rotate-config-after-new-root).

1. Rotate non configurable leaf certificates. For more information, see [Rotate non configurable Leaf Certificates from the new CAs](#regenerate-from-new-root).

1. Delete the old CAs. For more information, see [Delete the old CAs](#delete).

<p> The Services TLS CA, <code>/services/tls_ca</code>,
cannot be rotated using this procedure. For information about how to rotate the Services TLS CA, see <a href="advanced-certificate-rotation.html#services-rotation">Rotate the services TLS CA and the Leaf Certificates</a>
in <em>Advanced certificate rotation with CredHub Maestro</em>.</p>

### <a id='add-new-ca'></a> Step 1: Regenerate CAs

This section describes how to regenerate the CA certificates used by <%= vars.ops_manager %>, tiles, and service instances.

Optionally, you can provide your own custom CA for the <%= vars.ops_manager %> root CA instead of using one generated by <%= vars.ops_manager %>. The custom CA will be used to sign leaf certificates that are managed by <%= vars.ops_manager %>. Leaf certificates managed by CredHub are not signed using the <%= vars.ops_manager %> root CA and will be not be signed by the provided custom CA.

To regenerate CAs:

1. If you have not already done so, follow the procedure in [Using <%= vars.ops_manager %> API](../../install/ops-man-api.html) to target and authenticate with the <%= vars.ops_manager %> UAA server. Record your <%= vars.ops_manager %> access token, and use it for `UAA-ACCESS-TOKEN` in the following steps.
  <p> When you record your <%= vars.ops_manager %> access token, remove any newline characters such as <code>\n</code>.</p>

1. Use <%= vars.ops_manager %> to generate a new CA, or add your own custom CA:

    <p> Elliptic Curve Digital Signature Algorithm (ECDSA) certificates are not supported in <%= vars.ops_manager %>.</p>

    * **To use your own custom CA:** Call the <%= vars.ops_manager %> API `certificate_authorities` endpoint by running:

        ```
        curl "https://OPS-MANAGER-FQDN/api/v0/certificate_authorities" \
            -X POST \
            -H "Authorization: Bearer UAA-ACCESS-TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"cert_pem": "-----BEGIN CERTIFICATE-----CUSTOM-CERTIFICATE", "private_key_pem": "-----BEGIN RSA PRIVATE KEY-----RSA-KEY"}' \
            -i
        ```

        Where:

        * `OPS-MANAGER-FQDN` is the fully-qualified domain name (FQDN) of your <%= vars.ops_manager %> deployment.
        * `CUSTOM-CERTIFICATE` is your custom CA.
        * `RSA-KEY` is your RSA key.
        * `UAA-ACCESS-TOKEN` is your UAA access token.

        If the command succeeds, the API returns a response that includes the new CA.
        For example:

        <pre class="terminal">
        HTTP/1.1 200 OK
        {
              "certificate_authorities": [
                {
                  "guid": "f7bc18f34f2a7a9403c3",
                  "issuer": "CUSTOM-CERTIFICATE",
                  "created_on": "2017-01-09",
                  "expires_on": "2021-01-09",
                  "active": true,
                  "cert_pem": "-----BEGIN CERTIFICATE-----\nMIIC+zCCAeOgAwIBAgI....etc"
                }
              ]
        }
        </pre>

    * **To use an <%= vars.ops_manager %>-generated CA:** Call the <%= vars.ops_manager %> API `generate` endpoint by running:

        ```
        curl "https://OPS-MANAGER-FQDN/api/v0/certificate_authorities/generate" \
              -X POST \
              -H "Authorization: Bearer UAA-ACCESS-TOKEN" \
              -H "Content-Type: application/json" \
              -d '{}' \
              -i
        ```

        Where:

        * `OPS-MANAGER-FQDN` is the FQDN of your <%= vars.ops_manager %> deployment.
        * `UAA-ACCESS-TOKEN` is your UAA access token.

        If the command succeeds, the API returns a response that includes the new CA. For example:

        <pre class="terminal">
        HTTP/1.1 200 OK
        {
              "guid": "f7bc18f34f2a7a9403c3",
              "issuer": "VMware",
              "created_on": "2017-01-19",
              "expires_on": "2021-01-19",
              "active": false,
              "cert_pem": "-----BEGIN EXAMPLE CERTIFICATE-----
              MIIC+zCCAeOgAwIBAgIBADANBgkqhkiG9w0BAQsFADAfMQswCQYDVQQGEwJVUzEQ
              EXAMPLEoCgwHUGl2b3RhbDAeFw0xNDarthgyMTQyMjVaFw0yMTAxMTkyMTQyMjVa
              EXAMPLEoBgNVBAYTAlVTMRAwDgYDVVaderdQaXZvdGFsMIIBIjANBgkqhkiG9w0B
              EXAMPLEoAQ8AMIIBCgKCAQEAyV4OhPIIZTEym9OcdcNVip9Ev0ijPPLo9WPLUMzT
              EXAMPLEo/TgD+DP09mwVXfqwBlJmoj9DqRED1x/6bc0Ki/BAFo/P4MmOKm3QnDCt
              EXAMPLEooqgA++2HYrNTKWJ5fsXmERs8lK9AXXT7RKXhktyWWU3oNGf7zo0e3YKp
              EXAMPLEoh1NwIbNcGT1AurIDsxyOZy1HVzBLTisMyDogJmSCLsOw3qUDQjatjXKw
              EXAMPLEojG3nv2hvD4/aTOiHuKM3+AGbnaS2MdIOvFOh/7Y79tUp89csK0gs6uOd
              EXAMPLEohe4DcKw5CzUTfHKNXgHyeoVOBPcVQTp4lJp1iQIDAQABo0IwQDAdBgNV
              EXAMPLEoyH4y7VEuImLStXM0CKR8uVqxX/gwDwYDVR0TAQH/BAUwAwEB/zAOBgNV
              EXAMPLEoBAMCAQYwDQYJKoZIhvcNAQELBQADggEBALmHOPxdyBGnuR0HgR9V4TwJ
              EXAMPLEoGLKVT7am5z6G2Oq5cwACFHWAFfrPG4W9Jm577QtewiY/Rad/PbkY0YSY
              EXAMPLEokrfNjxjxI0H2sr7qLBFjJ0wBZHhVmDsO6A9PkfAPu4eJvqRMuL/xGmSQ
              EXAMPLEoCynMNz7FgHyFbd9D9X5YW8fWGSeVBPPikcONdRvjw9aEeAtbGEh8eZCP
              EXAMPLEob33RuR+CTNqThXY9k8d7/7ba4KVdd4gP8ynFgwvnDQOjcJZ6Go5QY5HA
              EXAMPLEoPFW8pAYcvWrXKR0rE8fL5o9qgTyjmO+5yyyvWIYrKPqqIUIvMCdNr84=
              -----END EXAMPLE CERTIFICATE-----"
        }
        </pre>

1. Confirm that the new CA is added by listing all the CAs for <%= vars.ops_manager %>. Run:

    ```
    curl "https://OPS-MANAGER-FQDN/api/v0/certificate_authorities" \
          -X GET \
          -H "Authorization: Bearer UAA-ACCESS-TOKEN" \
          -i
    ```

    Where:

    * `OPS-MANAGER-FQDN` is the FQDN of your <%= vars.ops_manager %> deployment.
    * `UAA-ACCESS-TOKEN` is your UAA access token.

    The API call returns the GUID of the newly added CA. For example:

    <pre class="terminal">
    HTTP/1.1 200 OK
    {
          "certificate_authorities": [
            {
              "guid": "f7bc18f34f2a7a9403c3",
              "issuer": "VMware",
              "created_on": "2017-01-09",
              "expires_on": "2021-01-09",
              "active": true,
              "cert_pem": "-----BEGIN CERTIFICATE-----\nMIIC+zCCAeOgAwIBAgI....etc"
            }
            {
              "guid": "a8ee01e33e3e3e3303e3",
              "issuer": "VMware",
              "created_on": "2017-04-09",
              "expires_on": "2021-04-09",
              "active": false,
              "cert_pem": "-----BEGIN CERTIFICATE-----\nzBBBC+eAAAe1gAwAAAeZ....etc"
            }
          ]
    }
    </pre>

1. Identify the newly added CA, which has `active` set to `false`. Record its GUID.

1. Configure the BOSH Director to recreate VMs: <%= partial 'skip_recreate_step' %>
    1. Go to `https://OPS-MANAGER-FQDN` in a browser, where `OPS-MANAGER-FQDN` is the FQDN of your <%= vars.ops_manager %> deployment.

    1. Log in to the <%= vars.ops_manager %> Installation Dashboard.

    1. Click the **BOSH Director** tile.

    1. Click **Director Config**.

    1. Enable the **Recreate VMs deployed by the BOSH Director** checkbox.
    This propagates the new CA to the BOSH Agent on each VM deployed by the BOSH Director,
    which enables the new leaf certificates to trust the new CA.

1. Return to <%= vars.ops_manager %> Installation Dashboard.

1. If you have service tiles installed, for each service tile:
    <p> The names of the <strong>Upgrade all service instances</strong> and <strong>Recreate all service instances</strong> errands might be slightly different between services.</p>
    1. Click the tile.
    1. Click the **Errands** tab.
    1. Enable the **Upgrade all service instances** errand. Running this errand is necessary to push CredHub certificate updates to each service instance.
    1. If the service tile has the **Recreate all service instances** errand, enable the **Recreate all service instances** errand. Running this errand pushes BOSH Agent certificate updates to service instances. <%= partial 'skip_recreate_step' %>

1. Click **Review Pending Changes**.
1. Click **Apply Changes**.
1. If you have service tiles installed and the service tile does not have the **Recreate all service instances** errand, manually push BOSH Agent certificate updates to each service instance. For each service instance, run:

    ```
    bosh -d SERVICE-INSTANCE-DEPLOYMENT recreate
    ```

    Where `SERVICE-INSTANCE-DEPLOYMENT` is the BOSH deployment name for the service instance.

    <%= partial 'skip_recreate_step' %>

When the deployment finishes and you have completed all necessary tasks to update service instances,
continue to the next section, [Activate the CAs](#activate-new-ca).

### <a id='activate-new-ca'></a> Step 2: Activate the CAs

To activate the CAs that you added in [Regenerate CAs](#add-new-ca):

1. Call the <%= vars.ops_manager %> API `activate` endpoint by running:

    ```
    curl "https://OPS-MANAGER-FQDN/api/v0/certificate_authorities/CERTIFICATE-GUID/activate" \
      -X POST \
      -H "Authorization: Bearer UAA-ACCESS-TOKEN" \
      -H "Content-Type: application/json" \
      -d '{}' \
      -i
    ```

    Where:

    * `OPS-MANAGER-FQDN` is the FQDN of your <%= vars.ops_manager %> deployment.
    * `CERTIFICATE-GUID` is the GUID of your CA that you retrieved in the previous section.
    * `UAA-ACCESS-TOKEN` is your UAA access token.

    The API returns a successful response:

    <pre class="terminal">HTTP/1.1 200 OK</pre>

1. List your <%= vars.ops_manager %> root CAs to confirm that the new root CA is active.
Run:

    ```
    curl "https://OPS-MANAGER-FQDN/api/v0/certificate_authorities" \
          -X GET \
          -H "Authorization: Bearer UAA-ACCESS-TOKEN" \
          -i
    ```

    Where:

    * `OPS-MANAGER-FQDN` is the FQDN of your <%= vars.ops_manager %> deployment.
    * `UAA-ACCESS-TOKEN` is your UAA access token.

1. Examine the response to ensure that your new root CA has the `active` property set to `true`.

### <a id='rotate-config-after-new-root'></a> Step 3: Rotate configurable leaf certificates

Any configurable leaf certificates generated from the <%= vars.ops_manager %> root CA must be rotated.
These are the leaf certificates that you generated using the **Generate RSA Certificate** button in the <%= vars.ops_manager %> UI. For example, see [Providing a Certificate for Your TLS Termination Point](https://docs.vmware.com/en/VMware-Tanzu-Application-Service/3.0/tas-for-vms/security_config.html) in the <%= vars.app_runtime_abbr %> documentation.

To regenerate and rotate each configurable leaf certificate that expires soon:

1. Find the text field where the leaf certificate is configured within the <%= vars.ops_manager %> UI. You might need to look through multiple configuration panes to identify the location of the certificate configuration text field. Use the following fields to identify the location of the certificate configuration text field:

    * The `product_guid` field in the <%= vars.ops_manager %> API output can help identify the tile in which the certificate is configured. For example, the prefix `p-bosh-` refers to the BOSH Director tile, and the prefix `cf-` refers to the <%= vars.app_runtime_abbr %> tile.
    * The `property_reference` field in the <%= vars.ops_manager %> API output can help identify the configuration pane in which the certificate is configured. For example, the `uaa.service_provider_key_credentials` property is configured in the **UAA** pane of the <%= vars.app_runtime_abbr %> tile.

1. Copy a new value for the leaf certificate into the text field or generate a new leaf certificate using the **Generate RSA Certificate** button.

1. Click **Save** in which you added new leaf certificates.

### <a id='regenerate-from-new-root'></a> Step 4: Rotate non-configurable leaf certificates from the new CAs

After you activate the new CAs, you must rotate the non configurable leaf certificates to ensure they are signed by the new CAs.

<!-- TODO: Create a section for excluded certs -->
<p> The <%= vars.ops_manager %> API also excludes from rotation the CAs for certain versions of the VMware Tanzu SQL [MySQL for VMs], Redis for VMware Tanzu, VMware Tanzu RabbitMQ, and VMware Tanzu GemFire tiles and IPsec for VMware Tanzu. For information about rotating these CAs, see the documentation for those products.</p>

To rotate non configurable leaf certificates:

1. Call the <%= vars.ops_manager %> API `regenerate` endpoint by running:

    ```
    curl "https://OPS-MANAGER-FQDN/api/v0/certificate_authorities/active/regenerate" \
          -X POST \
          -H "Authorization: Bearer UAA-ACCESS-TOKEN" \
          -H "Content-Type: application/json" \
          -d '{}' \
          -i
    ```

    Where:

    * `OPS-MANAGER-FQDN` is the FQDN of your <%= vars.ops_manager %> deployment.
    * `UAA-ACCESS-TOKEN` is your UAA access token.

    The API returns a successful response:

    <pre class="terminal">HTTP/1.1 200 OK</pre>

1. Configure the BOSH Director to recreate VMs: <%= partial 'skip_recreate_step' %>
    1. Go to <%= vars.ops_manager %> Installation Dashboard.

    1. Click the **BOSH Director** tile.

    1. Click **Director Config**.

    1. Enable the **Recreate VMs deployed by the BOSH Director** checkbox. This propagates the new CAs to all VMs deployed by the BOSH Director to prevent downtime.

    1. Return to <%= vars.ops_manager %> Installation Dashboard.

1. If you have service tiles installed, for each service tile:

    <p> The names of the <strong>Upgrade all service instances</strong> and <strong>Recreate all service instances</strong> errands might be slightly different between services.</p>

    1. Click the tile.
    1. Click the **Errands** tab.
    1. Enable the **Upgrade all service instances** errand. Running this errand is necessary to push CredHub certificate updates to each service instance.
    1. If the service tile has the **Recreate all service instances** errand: <%= partial 'skip_recreate_step' %>
      * Enable the **Recreate all service instances** errand. Running this errand pushes BOSH Agent certificate updates to service instances.

1. Click **Review Pending Changes**.
1. Click **Apply Changes**
1. If you have service tiles installed and the service tile does not have the **Recreate all service instances** errand: <%= partial 'skip_recreate_step' %>
  * Manually push BOSH Agent certificate updates to each service instance.

  For each service instance, run:

      ```
      bosh -d SERVICE-INSTANCE-DEPLOYMENT recreate
      ```

      Where `SERVICE-INSTANCE-DEPLOYMENT` is the BOSH deployment name for the service instance.

1. When the deployment finishes and you have completed all necessary tasks to update service instances,
continue to the next section, [Delete the old CAs](#delete).

### <a id='delete'></a> Step 5: Delete the old CAs

After activating new CAs and rotating leaf certificates from the new CAs, you must delete the old CAs. Deleting the old CAs ensures that each leaf certificate is only associated with the new CA that signs it, and that the old CAs are no longer trusted.

The <%= vars.ops_manager %> API call you use to delete your deployment's old root CA also marks the old versions of all CAs stored in CredHub as inactive, including those not generated by the old root CA.

<!-- TODO: While this information is accurate, needing to garbage collect CredHub certs should generally not be necessary -->
<p> This procedure does not delete leaf certificates stored in CredHub. It marks CredHub leaf certificates as transitional, which indicates that the leaf certificate is inactive. To delete CredHub leaf certificates, use the CredHub Maestro garbage collection feature. For information about CredHub Maestro certificate garbage collection, see <a href="advanced-certificate-rotation.html#garbage-collection">Delete Inactive Certificate Versions</a> in <em>Advanced Certificate Rotation with CredHub Maestro</em>.</p>

<p> Before you delete the old CA, ensure that you reviewed the <strong>Review Pending Changes</strong> page and clicked <strong>Apply Changes</strong> as part of <a href="#regenerate-from-new-root">Rotate Non-Configurable Leaf Certificates from the New CAs</a>.</p>

To delete the old CAs :

1. List your root CAs to retrieve the GUID of the old, inactive <%= vars.ops_manager %> root CA. Run:

    ```
    curl "https://OPS-MANAGER-FQDN/api/v0/certificate_authorities" \
          -X GET \
          -H "Authorization: Bearer UAA-ACCESS-TOKEN" \
          -i
    ```

    Where:

    * `OPS-MANAGER-FQDN` is the FQDN of your <%= vars.ops_manager %> deployment.
    * `UAA-ACCESS-TOKEN` is your UAA access token.

1. Delete the old <%= vars.ops_manager %> root CA by running:

    ```
    curl "https://OPS-MANAGER-FQDN/api/v0/certificate_authorities/OLD-CERTIFICATE-GUID" \
          -X DELETE \
          -H "Authorization: Bearer UAA-ACCESS-TOKEN" \
          -i
    ```

    Where:

    * `OPS-MANAGER-FQDN` is the FQDN of your <%= vars.ops_manager %> deployment.
    * `OLD-CERTIFICATE-GUID` is the GUID of the old <%= vars.ops_manager %> root CA.
    * `UAA-ACCESS-TOKEN` is your UAA access token.

    The API returns a successful response:

    <pre class="terminal">HTTP/1.1 200 OK</pre>

1. Configure the BOSH Director to re-create VMs: <%= partial 'skip_recreate_step' %>
    1. Go to <%= vars.ops_manager %> Installation Dashboard.

    1. Click the **BOSH Director** tile.

    1. Click **Director Config**.

    1. Enable the **Recreate VMs deployed by the BOSH Director** checkbox.

    1. Return to <%= vars.ops_manager %> Installation Dashboard.

1. If you have service tiles installed, for each service tile:

    <p. The names of the <strong>Upgrade all service instances</strong> and <strong>Recreate all service instances</strong> errands might be slightly different between services.</p>

    1. Click the tile.
    1. Click the **Errands** tab.
    1. Enable the **Upgrade all service instances** errand. Running this errand is necessary to push CredHub certificate updates to each service instance.
    1. If the service tile has the **Recreate all service instances** errand: <%= partial 'skip_recreate_step' %>
        * Enable the **Recreate all service instances** errand. Running this errand pushes BOSH Agent certificate updates to service instances.

1. Click **Review Pending Changes**.
1. Click **Apply Changes**.
1. If you have service tiles installed and the service tile does not have the **Recreate all service instances** errand: <%= partial 'skip_recreate_step' %>

    * Manually push BOSH Agent certificate updates to each service instance. For each service instance,
    run:

        ```
        bosh -d SERVICE-INSTANCE-DEPLOYMENT re-create
        ```

        Where `SERVICE-INSTANCE-DEPLOYMENT` is the BOSH deployment name for the service instance.

## <a id='specialized-procedures'></a> Certificates with specialized procedures

Some certificates are not rotated when using the standard rotation procedure.
The following table lists certificates that use a separate, specialized rotation procedure and provides
links to documentation and Knowledge Base articles to help you rotate these certificates.

| Certificate | Tile | Procedure |
|-------------|------|-----------|
| `/services/tls_ca` | _n/a_ | [Rotate the Services TLS CA and Its Leaf Certificates](advanced-certificate-rotation.html#services-rotation.html) |
| `/telemetry-ca-cert` | Telemetry v1.2.1 and earlier | [How to rotate the telemetry-ca-cert in Operations Manager](https://community.pivotal.io/s/article/How-to-rotate-the-telemetry-ca-cert) |
| `/services/tls_leaf` | <%= vars.app_runtime_abbr %> v2.10.0 – v2.10.13 | [Rotate /services/tls_leaf manually](https://community.pivotal.io/s/article/Rotate-services-tls-leaf-manually) |


## <a id='troubleshooting'></a> Troubleshooting

<%= partial "/pcf/certs/troubleshooting-maestro-violations" %>

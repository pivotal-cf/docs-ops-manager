---
title: Advanced certificate rotation with CredHub Maestro
owner: CredHub Maestro
---

This topic describes how you can rotate certificates and certificate authorities (CAs) in BOSH CredHub using CredHub Maestro. The topic only covers rotating certificates that are managed by CredHub.

For more information about setting up and using CredHub Maestro, see [Getting Started with CredHub Maestro](getting-started-with-maestro-cli.html).

## <a id='when-to-use'></a> When to use CredHub Maestro for certificate rotation

<%= vars.company_name %> recommends that you use the <%= vars.ops_manager_first %> API to perform bulk rotation of certificates. For more information, see [Overview of Certificate Rotation](api-cert-rotation.html).

However, there are some cases when you cannot use the <%= vars.ops_manager %> API to do bulk certificate rotation. In these cases, you can use CredHub Maestro to rotate certificates.

The following describes when to use CredHub Maestro instead of the <%= vars.ops_manager %> API for certificate rotation:

* You need to rotate one or more specific CredHub-managed certificates as part of a certificate rotation repair process due to errors returned by the standard procedure.

* You have <%= vars.k8s_runtime_first %> installed and therefore cannot use the <%= vars.ops_manager %> API to rotate CredHub-managed certificates. In <%= vars.k8s_runtime_abbr %> v1.9 and later, these include the cluster-specfic `kubo_ca_2018` and `etcd_ca_2018` CAs and their leaf certificates.
    <p class='note caution'><strong>Caution:</strong> In <%= vars.k8s_runtime_abbr %> v1.8 and earlier, you cannot use CredHub Maestro to rotate <%= vars.k8s_runtime_abbr %> certificates. To rotate these certificates, contact <a href="https://tanzu.vmware.com/support">Support</a>.</p>


## <a id='prerequisites'></a> Prerequisites

Before you rotate CredHub-managed certificates with CredHub Maestro:

* Before rotating certificates in <%= vars.ops_manager %> <%= vars.v_major_version %>, you must reset any certificates that were manually set in CredHub on <%= vars.ops_manager %> v2.6 and earlier to prevent them from being rotated with other certificates generated by CredHub. To find and reset any manually set certificates in CredHub, follow the procedure in [Reviewing Manually Set Certificates in CredHub](manual-credhub-certificate.html).

* To ensure that there is no app availability downtime during a rotation, <%= vars.company_name %> recommends that you scale up all instance groups and use an external blobstore.

* Check which tiles in your installation support certificate rotation with CredHub Maestro.
  Not every tile currently supports certificate rotation, so there is a potential for downtime.
  For more information about which tiles support certificate rotation,
  see [CredHub Maestro Tile Compatibility](maestro-tile-compatibility.html).

## <a id='check-expiration'></a> Check expiration dates and certificate types

This section describes how to manually check the expiration dates of the CAs and leaf certificates managed by CredHub.

After identifying the types of certificates that expire soon, you can determine which certificate rotation procedure to follow.

To check certificate expiration dates and types:

1. Retrieve a list of certificates expiring within a given timeframe by running:

    ```
    maestro list --expires-within TIME-PERIOD
    ```
    Where `TIME-PERIOD` is the unit for which you want to check the expiry window. Valid units are `d` for days, `w` for weeks, `m` for months, and `y` for years.

1. After you identify the list of certificates that expire soon, follow the procedure in [Rotate Certificates](#rotate-certs).


## <a id='rotate-certs'></a> Rotate certificates

This section explains how to rotate leaf certificates and CAs stored in CredHub. There are different rotation procedures for each type of certificate that requires rotation.

You can determine which rotation procedure to follow based on the types of certificates in your foundation that must be rotated.

To rotate certificates, follow one of the following procedures:

* If multiple CAs are expiring soon, see [Rotate All CAs and Leaf Certificates](#bulk-rotation).

* If the only certificates expiring are leaf certificates, see [Rotate All Leaf Certificates](#leaf-rotation).

* To only rotate a subset of CAs, see [Rotate a Single CA and Its Leaf Certificates](#single-rotation).

* To rotate the Services TLS CA, see [Rotate the Services TLS CA and Its Leaf Certificates](#services-rotation).

* To rotate CredHub-set CAs, see [Rotate CredHub-set CAs](#set-certificate-rotation).

* To rotate CredHub-set leaf certificates, see [Rotate CredHub-set Leaf Certificates](#set-leaf-certificate-rotation).

<p class='note'><strong>Note:</strong> All CredHub Maestro rotation commands have a dry-run flag that can be used to preview the certificates to be modified.</p>

### <a id='safety-checks'></a> Safety checks

CredHub Maestro performs basic safety checks when rotating certificates to prevent unsafe operations.

To skip CredHub Maestro safety checks, you can pass the `--skip-safety-check` flag to CredHub Maestro certificate rotation commands.

For more information, see [Troubleshooting CredHub Maestro Safety Violations During Certificate Rotation](troubleshoot-cert-errors.html).

### <a id='bulk-rotation'></a> Rotate all CAs and leaf certificates

This section describes the procedure for bulk rotating all CAs and leaf certificates using CredHub Maestro.

<%= vars.company_name %> recommends that you use the <%= vars.ops_manager %> API to perform bulk rotation of certificates unless you meet the conditions described in [When to Use CredHub Maestro for Certificate Rotation](#when-to-use).
<div class="note"><strong>Note:</strong> If your deployment includes Tanzu Kubernetes Grid Integrated Edition, using the <code>--all</code> option can damage your deployment. You can rotate individual CA certificates and their leaf certs instead. For TKGi-specific certificates, please follow the certificate rotation instructions at <a href="https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid-Integrated-Edition/1.15/tkgi/GUID-certificate-concepts.html#rotating-certificates-2">Rotating Certificates for Tanzu Kubernetes Grid Integrated Edition</a>.
  <br />
  <br />
  If any of your deployments use the Services TLS CA:
  <ul>
    <li>Run all CredHub Maestro commands except <code>maestro regenerate leaf</code> with <code>--exclude /services/tls_ca</code>.</li>
    <li>Run <code>maestro regenerate leaf</code> with <code>--exclude-signed-by /services/tls_ca</code>.</li>
  </ul>
The process for rotating the Services TLS CA requires additional steps to ensure that there is no downtime. To rotate the Services TLS CA, see <a href="#services-rotation">Rotate the Services TLS CA and Its Leaf Certificates</a>.</div>

To rotate all CAs and leaf certificates in CredHub:

1. Regenerate all CAs. This creates a new version of every CA and marks these new CA versions as transitional.
The transitional status indicates that these new CA versions will not yet sign any leaf certificates, though they
will be trusted by clients. Run:
    ```
    maestro regenerate ca --all
    ```

1. Re-deploy:
    1. Return to the <%= vars.ops_manager %> Installation Dashboard.
    1. Click **Review Pending Changes**.
    1. On the **Review Pending Changes** page, enable the **Select All Products** checkbox.
    1. For each service tile you have deployed:
        1. Verify that the **Recreate all service instances** errand is deactivated. You do not need to run this errand because when run by itself, CredHub Maestro does not update BOSH Agent certificates.
        1. Enable the **Upgrade all service instances** errand. Running this errand is necessary to push CredHub certificate updates to each service instance.

        <p class='note'><strong>Note:</strong> The names of the <strong>Recreate all service instances</strong> and the <strong>Upgrade all service instances</strong> errands might be slightly different between services.</p>

    1. Click **Apply Changes**.

2. Mark the signing version of each CA as transitional by running:

    ```
    maestro update-transitional signing --all
    ```

3. Regenerate all leaf certificates by running:

    ```
    maestro regenerate leaf --all
    ```

4. Re-deploy:
    1. Return to the <%= vars.ops_manager %> Installation Dashboard.
    1. Click **Review Pending Changes**.
    1. On the **Review Pending Changes** page, enable the **Select All Products** checkbox.
    1. For each service tile you have deployed:
        1. Verify that the **Recreate all service instances** errand is deactivated. You do not need to run this errand because when run by itself, CredHub Maestro does not update BOSH Agent certificates.
        1. Enable the **Upgrade all service instances** errand. Running this errand is necessary to push CredHub certificate updates to each service instance.

        <p class='note'><strong>Note:</strong> The names of the <strong>Recreate all service instances</strong> and the <strong>Upgrade all service instances</strong> errands might be slightly different between services.</p>

    1. Click **Apply Changes**.

5. Remove the transitional flag on all certificate versions. This removes the old, inactive CA versions on the next deploy. Run:

    ```
    maestro update-transitional remove --all
    ```

6. Re-deploy:

    1. Return to the <%= vars.ops_manager %> Installation Dashboard.
    2. Click **Review Pending Changes**.
    3. On the **Review Pending Changes** page, enable the **Select All Products** checkbox.
    4. For each service tile you have deployed:

        1. Verify that the **Recreate all service instances** errand is deactivated. You do not need to run this errand because when run by itself, CredHub Maestro does not update BOSH Agent certificates.
        2. Enable the **Upgrade all service instances** errand. Running this errand is necessary to push CredHub certificate updates to each service instance.

        <p class='note'><strong>Note:</strong> The names of the <strong>Recreate all service instances</strong> and the <strong>Upgrade all service instances</strong> errands might be slightly different between services.</p>

    5. Click **Apply Changes**.

### <a id='leaf-rotation'></a> Rotating all leaf certificates

This section describes the procedure for bulk rotating all leaf certificates using CredHub Maestro.

<%= vars.company_name %> recommends that you use the <%= vars.ops_manager %> API to perform bulk rotation of certificates unless you meet the conditions described in [When to Use CredHub Maestro for Certificate Rotation](#when-to-use).

<div class="note"><strong>Note:</strong>
  If your deployment includes Tanzu Kubernetes Grid Integrated Edition, using the <code>--all</code> option can damage your deployment. You can rotate leaf certs signed by individual CAs instead. For TKGi-specific certificates, please follow the certificate rotation instructions at <a href="https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid-Integrated-Edition/1.15/tkgi/GUID-certificate-concepts.html#rotating-certificates-2">Rotating Certificates for Tanzu Kubernetes Grid Integrated Edition</a>.
</div>

To rotate all leaf certificates in CredHub:

1. Regenerate all leaf certificates by running:

    ```
    maestro regenerate leaf --all
    ```

1. Re-deploy:
    1. Return to the <%= vars.ops_manager %> Installation Dashboard.
    1. Click **Review Pending Changes**.
    1. On the **Review Pending Changes** page, enable the **Select All Products** checkbox.
    1. For each service tile you have deployed:
        1. Verify that the **Recreate all service instances** errand is deactivated. You do not need to run this errand because when run by itself, CredHub Maestro does not update BOSH Agent certificates.
        1. Enable the **Upgrade all service instances** errand. Running this errand is necessary to push CredHub certificate updates to each service instance.

        <p class='note'><strong>Note:</strong> The names of the <strong>Recreate all service instances</strong> and the <strong>Upgrade all service instances</strong> errands might be slightly different between services.</p>

    1. Click **Apply Changes**.

### <a id='single-rotation'></a> Rotate a single CA and its leaf certificates

This section describes the procedure for rotating a single CA and its leaf certificates.

To rotate a single CA and its leaf certificates:

1. Regenerate the CA you want to rotate. This creates a new version of this CA. Run:

    ```
    maestro regenerate ca --name "CA-NAME"
    ```
    Where `CA-NAME` is the name of the CA you want to rotate. The CA name you provide must
    be the full path to the credential.

1. Re-deploy all deployments that use the CA.

1. Mark the signing version of the CA as transitional by running:

    ```
    maestro update-transitional signing --name "CA-NAME"
    ```
    Where `CA-NAME` is the name of the CA you want to mark as transitional.

1. Regenerate all leaf certificates signed by the CA by running:

    ```
    maestro regenerate leaf --signed-by "CA-NAME"
    ```
    Where `CA-NAME` is the name of the CA for which you want to regenerate leaf certificates.

1. Re-deploy all deployments that use the CA.

1. Remove the transitional flag from the CA. This removes the old, inactive CA version on the next deploy. Run:

    ```
    maestro update-transitional remove --name "CA-NAME"
    ```
    Where `CA-NAME` is the name of the CA you want to remove.

1. Re-deploy all deployments that use the CA.

### <a id='services-rotation'></a> Rotate the Services TLS CA and its leaf certificates

<%= partial 'minimum-duration' %>

This section describes the procedure for rotating the Services TLS CA and its leaf certificates.

Before you begin this rotation procedure, ensure that you have the following:

* Only one <%= vars.ops_manager %> foundation and not a multi-site or Wide Area Network (WAN) setup.
For a multi-site or WAN setup, you must perform the **Apply Changes** steps across all your sites or WAN.

* All certificates must include Subject Alternate Name (SAN) and Common Name (CN) entries.

* Your services are configured for high availability to minimize potential app impact during CA rotation. Rotating the Services TLS CA requires an upgrade all on-demand service instances, which can cause service downtime.

* Knowledge whether your deployment contains non-Java MySQL apps that rely on `VCAP_SERVICES` for TLS. You must rebind and restage these apps during the procedure, which can require additional time and coordination for the rotation. You do not need to rebind and restage MySQL apps that use `jdbcURL` or consume CA certificates from `/etc/ssl/certs/ca-certificate.crt`. For more information about determining which apps are affected, see [Rotating /services/tls_ca certificate using CredHub transitional certificate rotation feature](https://community.pivotal.io/s/article/Rotating-services-tls-ca-certificate-using-credhub-transitional-certificate-rotation-feature?language=en_US) in the Knowledge Base.

To rotate the Services TLS CA and its leaf certificates:

1. Check the [CredHub Maestro Tile Compatibility](maestro-tile-compatibility.html) document to ensure that all service tile versions currently deployed are compatible with Maestro.
    <p class='note caution'><strong>Caution:</strong> If you have any service tiles that are not compatible with CredHub Maestro, do not follow this procedure. If you do, you might experience extended downtime or data loss. Instead, follow the procedure in <a href="services_tls_ca_rotate.html">Rotating the Services TLS CA and Its Leaf Certificates</a>.</p>

1. Regenerate the Services TLS CA and mark the latest version of the CA as transitional. This creates a new version of the Services TLS CA and indicates that the latest version is inactive, so that all leaf certificates trust the new CA.
    1. On the Services TLS CA, see if your Services TLS CA was CredHub-set by running:

        ```
        maestro list
        ```
        After running this command, you see one Services TLS CA listed per deployment, but it is the same certificate.
    1. If the Services TLS CA was CredHub-set, run:

        ```
        maestro regenerate ca --name "/services/tls_ca" --force
        ```

1. Re-deploy:
    1. Return to the <%= vars.ops_manager %> Installation Dashboard.
    1. On the **Review Pending Changes** page, select **Select All Products** check box.
    1. For each service tile, enable the **Upgrade all service instances** errand.

         <p class='note'><strong>Note:</strong> The name of the <strong>Upgrade all service instances</strong> errand might be slightly different between services.</p>

    1. Click **Apply Changes**.

1. Rebind and restage the following apps:

    * For Tanzu GemFire for VMs apps, rebind and restage the apps.
    * For deployments that use MySQL for VMware Tanzu, rebind and restage all non-Java MySQL apps that rely on `VCAP_SERVICES` for TLS.

    <p class='note'><strong>Note:</strong> The bg-restage plug-in enables zero-downtime blue-green restaging without access to the app source code. For more information, see <a href="https://github.com/orange-cloudfoundry/cf-plugin-bg-restage">bg-restage</a> on GitHub.</p>

1. Mark the signing version of the Services TLS CA as transitional by running:

    ```
    maestro update-transitional signing --name "/services/tls_ca"
    ```

1. Regenerate all service instance certificates signed by the Services TLS CA by running:

    ```
    maestro regenerate leaf --signed-by "/services/tls_ca"
    ```

1. Re-deploy:

    1. Return to the <%= vars.ops_manager %> Installation Dashboard.
    2. On the **Review Pending Changes** page, enable the **Select All Products** checkbox.
    3. For each service tile, enable the **Upgrade all service instances** errand.

        <p class='note'><strong>Note:</strong> The name of the <strong>Upgrade all service instances</strong> errand might be slightly different between services.</p>

    4. Click **Apply Changes**.

1. Rebind and restage the following apps:
    * For Tanzu GemFire for VMs apps, rebind and restage the apps.
    * For deployments that use MySQL for VMware Tanzu, rebind and restage all non-Java MySQL apps that rely on `VCAP_SERVICES` for TLS.

1. Remove the transitional flag from the Services TLS CA. This removes the old, inactive version of the Services TLS CA on the next deployment. Run:

    ```
    maestro update-transitional remove --name "/services/tls_ca"
    ```

1. Re-deploy:

    1. Return to the <%= vars.ops_manager %> Installation Dashboard.
    2. On the **Review Pending Changes** page, enable the **Select All Products** checkbox.
    3. For each service tile, enable the **Upgrade all service instances** errand.

        <p class='note'><strong>Note:</strong> The name of the <strong>Upgrade all service instances</strong> errand might be slightly different between services.</p>

    4. Click **Apply Changes**.

1. Rebind and restage the following apps:
    * For Tanzu GemFire for VMs apps, rebind and restage the apps.
    * For deployments that use MySQL for VMware Tanzu, rebind and restage all non-Java MySQL apps that rely on `VCAP_SERVICES` for TLS.

### <a id='set-certificate-rotation'></a> Rotate CredHub-set CAs

This section describes the procedure for rotating CAs that are manually set in CredHub.

To rotate a CredHub-set CA:

1. Create a new CA using the same parameters you used for the original CA.

1. Use the CredHub CLI or CredHub API to set the new CA at the same path as the original. To download and install the CredHub CLI, see the [CredHub CLI](https://github.com/cloudfoundry-incubator/credhub-cli) repository on GitHub. For more information about the CredHub API, see the [CredHub API documentation](https://docs.cloudfoundry.org/api/credhub/).

1. Verify which tiles or service instances are using the rotated certificate.
  1. Get the list of deployment names using one of the following methods:
      - To get a list of deployments using the CA or its leaf certificates, run the following command:

          ```
          maestro --json ls | jq -r '.metadata[] | select(.name == "/PATH/TO/CA/IN/CREDHUB" or .signed_by == "/PATH/TO/CA/IN/CREDHUB") | .deployment_name' | sort | uniq
          ```
      - To verify the deployments manually:
          1. Use Maestro to get a list of all certificates by running:

                ```
                maestro ls
                ```
          1. Locate the output entries whose name or `signed_by` field matches the CredHub path of the CA that was rotated. Certificates might be listed multiple times if they are associated with multiple deployments.
          1. For each output entry, look at the `deployment_name` key. This corresponds to a tile that you must re-deploy.
  1. Entries with a deployment name like `service-instance-*` are certificates associated with a service instance created by a service tile. You must re-deploy the corresponding service tile and enable its **Upgrade all service instances** errand.

1. Re-deploy:
    1. Return to the <%= vars.ops_manager %> Installation Dashboard.
    1. Click **Review Pending Changes**.
    1. On the **Review Pending Changes** page, enable the checkbox for all products using the rotated certificates. If unsure, enable the **Select All Products** checkbox.
    1. For each service tile you are deploying:
        1. Verify that the **Recreate all service instances** errand is deactivated. You do not need to run this errand because when run by itself, CredHub Maestro does not update BOSH Agent certificates.
        1. Enable the **Upgrade all service instances** errand. Running this errand is necessary to push CredHub certificate updates to each service instance.

        <p class='note'><strong>Note:</strong> The names of the <strong>Recreate all service instances</strong> and the <strong>Upgrade all service instances</strong> errands might be slightly different between services.</p>

    1. Click **Apply Changes**.

2. Mark the signing version of the single CA as transitional by running:

    ```
    maestro update-transitional signing --name "CA-NAME"
    ```

3. Regenerate all leaf certificates that are signed by the CA you are rotating. Run:

    ```
    maestro regenerate leaf --signed-by "CA-NAME"
    ```
    <p class='note'><strong>Note:</strong> You might need to use the <code>--force</code> flag when regenerating leaf certificates if they were set by CredHub. Otherwise, you must provide a new leaf certificate at the same path.</p>

4. Re-deploy:
    1. Return to the <%= vars.ops_manager %> Installation Dashboard.
    1. Click **Review Pending Changes**.
    1. On the **Review Pending Changes** page, enable the checkbox for all products using the rotated certificates. If unsure, enable the **Select All Products** checkbox.
    1. For each service tile you are deploying:
        1. Verify that the **Recreate all service instances** errand is deactivated. You do not need to run this errand because when run by itself, CredHub Maestro does not update BOSH Agent certificates.
        1. Enable the **Upgrade all service instances** errand. Running this errand is necessary to push CredHub certificate updates to each service instance.

        <p class='note'><strong>Note:</strong> The names of the <strong>Recreate all service instances</strong> and the <strong>Upgrade all service instances</strong> errands might be slightly different between services.</p>

    1. Click **Apply Changes**.

5. Remove the transitional flag from the single CA. This removes the old, inactive CA version on the next deploy. Run:

    ```
    maestro update-transitional remove --name "CA-NAME"
    ```

6. Re-deploy:
    1. Return to the <%= vars.ops_manager %> Installation Dashboard.
    1. Click **Review Pending Changes**.
    1. On the **Review Pending Changes** page, enable the checkbox for all products using the rotated certificates. If unsure, enable the **Select All Products** checkbox.
    1. For each service tile you are deploying:
        1. Verify that the **Recreate all service instances** errand is deactivated. You do not need to run this errand because when run by itself, CredHub Maestro does not update BOSH Agent certificates.
        1. Enable the **Upgrade all service instances** errand. Running this errand is necessary to push CredHub certificate updates to each service instance.

        <p class='note'><strong>Note:</strong> The names of the <strong>Recreate all service instances</strong> and the <strong>Upgrade all service instances</strong> errands might be slightly different between services.</p>

    1. Click **Apply Changes**.

### <a id='set-leaf-certificate-rotation'></a> Rotate CredHub-set leaf certificates

This section describes the procedure for rotating leaf certificates that are manually set in CredHub.

To rotate a CredHub-set leaf certificate:

1. Create a new leaf certificate using the same parameters you used for the original leaf certificate.

1. Use the CredHub CLI or CredHub API to set the new leaf certificate at the same path as the original. To download and install the CredHub CLI, see the [CredHub CLI](https://github.com/cloudfoundry-incubator/credhub-cli) repository on GitHub. For more information about the CredHub API, see the [CredHub API documentation](https://docs.cloudfoundry.org/api/credhub/).

1. Verify which tiles or service instances are using the rotated certificate.
  1. Get the list of deployment names using one of the following methods:
      - To get a list of deployments using the CA or its leaf certificates, run the following command:

          ```
          maestro --json ls | jq -r '.metadata[] | select(.name == "/PATH/TO/CERTIFICATE/IN/CREDHUB") | .deployment_name' | sort | uniq
          ```
      - To verify the deployments manually:
          1. Use Maestro to get a list of all certificates by running:

                ```
                maestro ls
                ```
          1. Locate the output entries whose name matches the CredHub path of the certificate that was rotated. Note that a certificate might be listed multiple times if it is associated with multiple deployments.
  1. For each output entry, look at the `deployment_name` key. This corresponds to a tile that you must re-deploy. Entries with a deployment name like `service-instance-*` are certificates associated with a service instance created by a service tile. You must re-deploy the corresponding service tile and enable its **Upgrade all service instances** errand.

1. Re-deploy:
    1. Return to the <%= vars.ops_manager %> Installation Dashboard.
    1. Click **Review Pending Changes**.
    1. On the **Review Pending Changes** page, enable the checkbox for all products using the rotated certificate. If unsure, enable the **Select All Products** checkbox.
    1. For each service tile you are deploying:
        1. Verify that the **Recreate all service instances** errand is deactivated. You do not need to run this errand because when run by itself, CredHub Maestro does not update BOSH Agent certificates.
        1. Enable the **Upgrade all service instances** errand. Running this errand is necessary to push CredHub certificate updates to each service instance.

        <p class='note'><strong>Note:</strong> The names of the <strong>Recreate all service instances</strong> and the <strong>Upgrade all service instances</strong> errands might be slightly different between services.</p>

    1. Click **Apply Changes**.


## <a id='garbage-collection'></a> Delete inactive certificate versions

Over the course of many rotations, it is possible for the CredHub database to fill up. In order to prevent this, you can periodically use CredHub Maestro's garbage collect functionality to delete old, unused certificate versions.

You can run garbage collect on leaf certificates and CAs. Generally, deleting leaf certificates is enough to free up space in the database.

To see if you need to run garbage collect, do one of the following:

* Manually verify the BOSH Director's VM vitals through your IaaS provider.

* SSH into the BOSH Director and run `df -h /var/vcap/store`.

<p class='note caution'><strong>Caution:</strong> To enhance the safety of the garbage collect command, CredHub Maestro only deletes versions of a certificate older than the currently active version. To delete all inactive versions of CAs or leaf certificates, add the <code>--force</code> flag to the garbage collect command. <%= vars.company_name %> does not recommend using the <code>--force</code> flag during a rotation.</p>

### <a id='leaf-cert-cleanup'></a> Delete all leaf certificates

To delete all leaf certificates:

1. Determine which certificate versions you want to delete by running:

    ```
    maestro garbage-collect leaf --all --dry-run
    ```

1. Delete the certificate versions by running:

    ```
    maestro garbage-collect leaf --all
    ```

### <a id='ca-cleanup'></a> Delete all CAs

To delete all CAs:

1. Determine which CA versions you want to delete by running:

    ```
    maestro garbage-collect ca --all --dry-run
    ```

1. Delete the CA versions by running:

    ```
    maestro garbage-collect ca --all
    ```

### <a id='single-leaf-cert-cleanup'></a> Delete a single leaf certificate

To delete a single leaf certificate:

1. Determine which certificate versions you want to delete by running:

    ```
    maestro garbage-collect leaf --name "LEAF-CERTIFICATE-NAME" --dry-run
    ```

1. Delete the certificate versions by running:

    ```
    maestro garbage-collect leaf --name "LEAF-CERTIFICATE-NAME"
    ```

### <a id='single-ca-cleanup'></a> Delete a single CA

To delete a single CA:

1. Determine which CA you want to delete by running:

    ```
    maestro garbage-collect ca --name "CA-NAME" --dry-run
    ```
    Where `CA-NAME` is the name of the CA you want to delete.

1. Delete the CA by running:

    ```
    maestro garbage-collect ca --name "CA-NAME"
    ```
    Where `CA-NAME` is the name of the CA you want to delete.
